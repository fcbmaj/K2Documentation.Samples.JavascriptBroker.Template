{"version":3,"file":"test.js","sources":["../src/test.ts"],"sourcesContent":["import test from \"ava\";\r\nimport \"@k2oss/k2-broker-core/test-framework\";\r\nimport \"./index\";\r\n\r\nfunction mock(name: string, value: any) {\r\n  global[name] = value;\r\n}\r\n\r\ntest(\"describe returns the hardcoded instance\", async (t) => {\r\n  let schema = null;\r\n  mock(\"postSchema\", function (result: any) {\r\n    schema = result;\r\n  });\r\n\r\n  await Promise.resolve<void>(\r\n    ondescribe({\r\n      configuration: {},\r\n    })\r\n  );\r\n\r\n  t.deepEqual(schema, {\r\n    objects: {\r\n      todo: {\r\n        displayName: \"TODO\",\r\n        description: \"Manages a TODO list\",\r\n        properties: {\r\n          id: {\r\n            displayName: \"ID\",\r\n            type: \"number\",\r\n          },\r\n          userId: {\r\n            displayName: \"User ID\",\r\n            type: \"number\",\r\n          },\r\n          title: {\r\n            displayName: \"Title\",\r\n            type: \"string\",\r\n          },\r\n          completed: {\r\n            displayName: \"Completed\",\r\n            type: \"boolean\",\r\n          },\r\n        },\r\n        methods: {\r\n          get: {\r\n            displayName: \"Get TODO\",\r\n            type: \"read\",\r\n            inputs: [\"id\"],\r\n            outputs: [\"id\", \"userId\", \"title\", \"completed\"],\r\n          },\r\n          getParams: {\r\n            displayName: \"Get TODO\",\r\n            type: \"read\",\r\n            parameters: {\r\n              pid: {\r\n                displayName: \"param1\",\r\n                description: \"Description Of Param 1\",\r\n                type: \"number\",\r\n              },\r\n            },\r\n            requiredParameters: [\"pid\"],\r\n            outputs: [\"id\"],\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  t.pass();\r\n});\r\n\r\ntest(\"execute fails with the wrong parameters\", async (t) => {\r\n  let error = await t.throwsAsync(\r\n    Promise.resolve<void>(\r\n      onexecute({\r\n        objectName: \"test1\",\r\n        methodName: \"unused\",\r\n        parameters: {},\r\n        properties: {},\r\n        configuration: {},\r\n        schema: {},\r\n      })\r\n    )\r\n  );\r\n\r\n  t.deepEqual(error.message, \"The object test1 is not supported.\");\r\n\r\n  error = await t.throwsAsync(\r\n    Promise.resolve<void>(\r\n      onexecute({\r\n        objectName: \"todo\",\r\n        methodName: \"test2\",\r\n        parameters: {},\r\n        properties: {},\r\n        configuration: {},\r\n        schema: {},\r\n      })\r\n    )\r\n  );\r\n\r\n  t.deepEqual(error.message, \"The method test2 is not supported.\");\r\n\r\n  t.pass();\r\n});\r\n\r\ntest(\"execute passes with method params\", async (t) => {\r\n  let result: any = null;\r\n  function pr(r: any) {\r\n    result = r;\r\n  }\r\n\r\n  mock(\"postResult\", pr);\r\n\r\n  await Promise.resolve<void>(\r\n    onexecute({\r\n      objectName: \"todo\",\r\n      methodName: \"getParams\",\r\n      parameters: {\r\n        pid: 456,\r\n      },\r\n      properties: {},\r\n      configuration: {},\r\n      schema: {},\r\n    })\r\n  );\r\n\r\n  t.deepEqual(result, {\r\n    id: 456,\r\n  });\r\n\r\n  t.pass();\r\n});\r\n\r\ntest(\"execute passes\", async (t) => {\r\n  let xhr: { [key: string]: any } = null;\r\n  class XHR {\r\n    public onreadystatechange: () => void;\r\n    public readyState: number;\r\n    public status: number;\r\n    public responseText: string;\r\n    private recorder: { [key: string]: any };\r\n\r\n    constructor() {\r\n      xhr = this.recorder = {};\r\n      this.recorder.headers = {};\r\n    }\r\n\r\n    open(method: string, url: string) {\r\n      this.recorder.opened = { method, url };\r\n    }\r\n\r\n    setRequestHeader(key: string, value: string) {\r\n      this.recorder.headers[key] = value;\r\n    }\r\n\r\n    send() {\r\n      queueMicrotask(() => {\r\n        this.readyState = 4;\r\n        this.status = 200;\r\n        this.responseText = JSON.stringify({\r\n          id: 123,\r\n          userId: 51,\r\n          title: \"Groceries\",\r\n          completed: false,\r\n        });\r\n        this.onreadystatechange();\r\n        delete this.responseText;\r\n      });\r\n    }\r\n  }\r\n\r\n  mock(\"XMLHttpRequest\", XHR);\r\n\r\n  let result: any = null;\r\n  function pr(r: any) {\r\n    result = r;\r\n  }\r\n\r\n  mock(\"postResult\", pr);\r\n\r\n  await Promise.resolve<void>(\r\n    onexecute({\r\n      objectName: \"todo\",\r\n      methodName: \"get\",\r\n      parameters: {},\r\n      properties: {\r\n        id: 123,\r\n      },\r\n      configuration: {},\r\n      schema: {},\r\n    })\r\n  );\r\n\r\n  t.deepEqual(xhr, {\r\n    opened: {\r\n      method: \"GET\",\r\n      url: \"https://jsonplaceholder.typicode.com/todos/123\",\r\n    },\r\n    headers: {\r\n      test: \"test value\",\r\n    },\r\n  });\r\n\r\n  t.deepEqual(result, {\r\n    id: 123,\r\n    userId: 51,\r\n    title: \"Groceries\",\r\n    completed: false,\r\n  });\r\n\r\n  t.pass();\r\n});\r\n"],"names":["mock","name","value","global","test","async","schema","result","Promise","resolve","ondescribe","configuration","t","deepEqual","objects","todo","displayName","description","properties","id","type","userId","title","completed","methods","get","inputs","outputs","getParams","parameters","pid","requiredParameters","pass","error","throwsAsync","onexecute","objectName","methodName","message","r","xhr","constructor","this","recorder","headers","open","method","url","opened","setRequestHeader","key","send","queueMicrotask","readyState","status","responseText","JSON","stringify","onreadystatechange"],"mappings":"wLAIA,SAASA,EAAKC,EAAcC,GAC1BC,OAAOF,GAAQC,EAGjBE,UAAK,0CAA2CC,MAAAA,QAC1CC,EAAS,KACbN,EAAK,cAAc,SAAUO,GAC3BD,EAASC,WAGLC,QAAQC,QACZC,WAAW,CACTC,cAAe,MAInBC,EAAEC,UAAUP,EAAQ,CAClBQ,QAAS,CACPC,KAAM,CACJC,YAAa,OACbC,YAAa,sBACbC,WAAY,CACVC,GAAI,CACFH,YAAa,KACbI,KAAM,UAERC,OAAQ,CACNL,YAAa,UACbI,KAAM,UAERE,MAAO,CACLN,YAAa,QACbI,KAAM,UAERG,UAAW,CACTP,YAAa,YACbI,KAAM,YAGVI,QAAS,CACPC,IAAK,CACHT,YAAa,WACbI,KAAM,OACNM,OAAQ,CAAC,MACTC,QAAS,CAAC,KAAM,SAAU,QAAS,cAErCC,UAAW,CACTZ,YAAa,WACbI,KAAM,OACNS,WAAY,CACVC,IAAK,CACHd,YAAa,SACbC,YAAa,yBACbG,KAAM,WAGVW,mBAAoB,CAAC,OACrBJ,QAAS,CAAC,YAOpBf,EAAEoB,SAGJ5B,UAAK,0CAA2CC,MAAAA,QAC1C4B,QAAcrB,EAAEsB,YAClB1B,QAAQC,QACN0B,UAAU,CACRC,WAAY,QACZC,WAAY,SACZR,WAAY,GACZX,WAAY,GACZP,cAAe,GACfL,OAAQ,OAKdM,EAAEC,UAAUoB,EAAMK,QAAS,sCAE3BL,QAAcrB,EAAEsB,YACd1B,QAAQC,QACN0B,UAAU,CACRC,WAAY,OACZC,WAAY,QACZR,WAAY,GACZX,WAAY,GACZP,cAAe,GACfL,OAAQ,OAKdM,EAAEC,UAAUoB,EAAMK,QAAS,sCAE3B1B,EAAEoB,SAGJ5B,UAAK,oCAAqCC,MAAAA,QACpCE,EAAc,KAKlBP,EAAK,uBAJOuC,GACVhC,EAASgC,WAKL/B,QAAQC,QACZ0B,UAAU,CACRC,WAAY,OACZC,WAAY,YACZR,WAAY,CACVC,IAAK,KAEPZ,WAAY,GACZP,cAAe,GACfL,OAAQ,MAIZM,EAAEC,UAAUN,EAAQ,CAClBY,GAAI,MAGNP,EAAEoB,SAGJ5B,UAAK,iBAAkBC,MAAAA,QACjBmC,EAA8B,KAqClCxC,EAAK,uBA7BHyC,cACED,EAAME,KAAKC,SAAW,QACjBA,SAASC,QAAU,GAG1BC,KAAKC,EAAgBC,QACdJ,SAASK,OAAS,CAAEF,OAAAA,EAAQC,IAAAA,GAGnCE,iBAAiBC,EAAahD,QACvByC,SAASC,QAAQM,GAAOhD,EAG/BiD,OACEC,eAAe,UACRC,WAAa,OACbC,OAAS,SACTC,aAAeC,KAAKC,UAAU,CACjCtC,GAAI,IACJE,OAAQ,GACRC,MAAO,YACPC,WAAW,SAERmC,4BACEhB,KAAKa,sBAOdhD,EAAc,KAKlBP,EAAK,uBAJOuC,GACVhC,EAASgC,WAKL/B,QAAQC,QACZ0B,UAAU,CACRC,WAAY,OACZC,WAAY,MACZR,WAAY,GACZX,WAAY,CACVC,GAAI,KAENR,cAAe,GACfL,OAAQ,MAIZM,EAAEC,UAAU2B,EAAK,CACfQ,OAAQ,CACNF,OAAQ,MACRC,IAAK,kDAEPH,QAAS,CACPxC,KAAM,gBAIVQ,EAAEC,UAAUN,EAAQ,CAClBY,GAAI,IACJE,OAAQ,GACRC,MAAO,YACPC,WAAW,IAGbX,EAAEoB"}